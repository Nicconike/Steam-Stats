name: Release

on:
    workflow_call:
        inputs:
            repo_name:
                required: true
                type: string
            docker_image:
                required: true
                type: string
        secrets:
            APP_ID:
                required: true
            APP_PRIVATE_KEY:
                required: true
            DOCKER_TOKEN:
                required: true
    push:
        branches: [master]
        tags:
            - "v*"
        paths:
            - ".github/workflows/release.yml"
            - "api/*.py"
            - "templates/*.j2"
            - "pyproject.toml"
            - "Dockerfile"

permissions:
    contents: read

jobs:
    release:
        if: |
            github.actor != 'dependabot[bot]' &&
            github.actor != 'github-actions[bot]' &&
            github.actor != 'protected-auto-commits[bot]'
        name: Release
        runs-on: ubuntu-latest
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}
        permissions:
            id-token: write
            contents: write
        environment:
            name: pypi
            url: https://pypi.org/project/Steam-Stats/
        outputs:
            released: ${{ steps.semantic.outputs.released }}
            version: ${{ steps.semantic.outputs.version }}
            previous_version: ${{ steps.semantic.outputs.previous_version }}
        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: GitHub App Token
              uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
              id: app-token
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}

            - name: Checkout Code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0
                  token: ${{ steps.app-token.outputs.token }}

            - name: Setup Python
              uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
              with:
                  python-version: "3.13"
                  cache: "pip"

            - name: Cache Dependencies
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install python-semantic-release

            - name: Update to Latest Commit
              run: |
                  git fetch origin
                  git reset --hard origin/${{ github.ref_name }}

            - name: Semantic Release
              id: semantic
              uses: python-semantic-release/python-semantic-release@4d4cb0ab842247caea1963132c242c62aab1e4d5 # v10.4.1
              with:
                  github_token: ${{ steps.app-token.outputs.token }}
              env:
                  PYTHON_KEYRING_BACKEND: keyring.backends.null.Keyring

            - name: Publish to GitHub Release Assets
              uses: python-semantic-release/publish-action@v10.4.1
              with:
                  github_token: ${{ steps.app-token.outputs.token }}
                  tag: ${{ steps.semantic.outputs.tag }}

            - name: Build distribution
              run: |
                  python -m pip install --upgrade build
                  python -m build

            - name: Publish to PyPI
              if: steps.semantic.outputs.released == 'true'
              uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
              with:
                  packages-dir: dist
                  print-hash: true
                  verbose: true

    docker:
        name: Docker
        runs-on: ubuntu-latest
        needs: release
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}
        permissions:
            contents: read
            attestations: write
            id-token: write
            packages: write
        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: GitHub App Token
              uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
              id: app-token
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}

            - name: Checkout Code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0
                  token: ${{ steps.app-token.outputs.token }}

            - name: Install CoSign
              if: github.event_name != 'pull_request'
              uses: sigstore/cosign-installer@d7543c93d881b35a8faa02e8e3605f69b7a1ce62 # v3.10.0
              with:
                  cosign-release: "v2.5.0"

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

            - name: Login to Docker Hub
              uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
              with:
                  username: ${{ vars.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Login to GitHub Container Registry
              uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract Docker Metadata
              id: meta
              uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5.8.0
              with:
                  images: |
                      ${{ vars.DOCKER_USERNAME }}/${{ github.event.repository.name }}
                      ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
                  tags: |
                      type=raw,value=master
                      type=raw,value=v${{ needs.release.outputs.version }}

            - name: Build & Push Docker Image
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
              id: push
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  platforms: linux/amd64
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  secrets: |
                      GITHUB_TOKEN=${{ steps.app-token.outputs.token }}

            - name: Sign the published Docker Image
              if: ${{ github.event_name != 'pull_request' }}
              env:
                  TAGS: ${{ steps.meta.outputs.tags }}
                  DIGEST: ${{ steps.push.outputs.digest }}
              run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}

            - name: Generate Artifact Attestation
              uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
              with:
                  subject-name: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
                  subject-digest: ${{ steps.push.outputs.digest }}
                  push-to-registry: true

            - name: Docker Scout Scan
              uses: docker/scout-action@f8c776824083494ab0d56b8105ba2ca85c86e4de # v1.18.2
              with:
                  command: quickview, cves
                  image: ${{ vars.DOCKER_USERNAME }}/${{ github.event.repository.name }}:master
                  write-comment: true
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  sarif-file: docker-scout-results.sarif

            - name: Upload Scout Scan Results
              if: always()
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
              with:
                  name: docker-scout-results
                  path: docker-scout-results.sarif

    cleanup:
        runs-on: ubuntu-latest
        name: Cleanup
        needs: [release, docker]
        concurrency:
            group: ${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}
        permissions:
            contents: read
            packages: write
        env:
            CURRENT_TAG: ${{ needs.release.outputs.version }}
            PREV_TAG: ${{ needs.release.outputs.previous_version }}
        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Delete Old Docker Hub Tags
              env:
                  USERNAME: ${{ vars.DOCKER_USERNAME }}
                  PASSWORD: ${{ secrets.DOCKER_TOKEN }}
                  REPO: ${{ github.event.repository.name }}
                  KEEP_TAGS: "master,${{ env.CURRENT_TAG }},${{ env.PREV_TAG }}"
              run: |
                  set -euo pipefail
                  echo "Keeping tags: $KEEP_TAGS"

                  # Get auth token for Registry API
                  TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${USERNAME}/${REPO}:pull,push,delete" | jq -r .token)

                  if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
                    echo "Failed to get Docker Hub auth token"
                    exit 1
                  fi

                  # List all tags
                  TAGS_JSON=$(curl -H "Authorization: Bearer $TOKEN" -s \
                    "https://registry-1.docker.io/v2/${USERNAME}/${REPO}/tags/list")

                  TAGS=$(echo "$TAGS_JSON" | jq -r '.tags[]' 2>/dev/null || echo "")

                  if [ -z "$TAGS" ]; then
                    echo "No tags found in Docker Hub registry"
                    exit 0
                  fi

                  echo "All tags found: $TAGS"

                  # Delete tags
                  for tag in $TAGS; do
                    if [[ "|$KEEP_TAGS|" != *"|$tag|"* ]]; then
                      echo "Deleting tag: $tag"

                      # Get manifest digest
                      DIGEST=$(curl -H "Authorization: Bearer $TOKEN" \
                        -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
                        -I -s "https://registry-1.docker.io/v2/${USERNAME}/${REPO}/manifests/${tag}" | \
                        grep -i docker-content-digest | awk '{print $2}' | tr -d '\r')

                      if [ -n "$DIGEST" ]; then
                        # Delete manifest (this removes the tag)
                        RESULT=$(curl -H "Authorization: Bearer $TOKEN" \
                          -X DELETE \
                          -s -w "%{http_code}" \
                          "https://registry-1.docker.io/v2/${USERNAME}/${REPO}/manifests/${DIGEST}")
                        echo "Deletion result for $tag: HTTP $RESULT"
                      else
                        echo "Could not get digest for tag: $tag"
                      fi
                    else
                      echo "Keeping tag: $tag"
                    fi
                  done

            - name: Delete Old GHCR Versions
              uses: actions/delete-package-versions@e5bc658cc4c965c472efe991f8beea3981499c55 # v5.0.0
              with:
                  package-name: ${{ github.event.repository.name }}
                  package-type: "container"
                  min-versions-to-keep: 3
                  ignore-versions: "^(master|v?${{ env.CURRENT_TAG }}|v?${{ env.PREV_TAG }})$"
                  token: ${{ secrets.GITHUB_TOKEN }}
