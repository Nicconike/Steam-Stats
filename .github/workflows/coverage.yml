name: "Code Coverage"

on:
    push:
        branches: [ "master" , "tests"]
        paths:
            - ".github/workflows/coverage.yml"
            - "api/*.py"
            - "tests/*.py"
    pull_request:
        branches: [ "master" ]

jobs:
    code-coverage:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Set up Python
            uses: actions/setup-python@v5
            with:
                python-version: "3.x"
                cache: "pip"

          - name: Install Dependencies
            run: pip install -r requirements.txt

          - name: Run tests with coverage
            run: |
                pytest --cov=api.main --cov=api.steam_stats --cov=api.steam_workshop --cov-report=xml --cov-report=term
            env:
                INPUT_STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
                INPUT_STEAM_ID: ${{ vars.STEAM_ID }}
                INPUT_STEAM_CUSTOM_ID: ${{ vars.STEAM_CUSTOM_ID }}
                INPUT_WORKSHOP_STATS: True
                INPUT_LOG_SCALE: True

          - name: Upload coverage to Codecov
            uses: codecov/codecov-action@v4
            with:
                token: ${{ secrets.CODECOV_TOKEN }}
                files: ./coverage.xml
                flags: unittests
                name: codecov-umbrella
                fail_ci_if_error: true
