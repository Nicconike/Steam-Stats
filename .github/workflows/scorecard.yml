name: Scorecard Security
on:
    workflow_dispatch:
    workflow_call:
        secrets:
            APP_ID:
                required: true
            APP_PRIVATE_KEY:
                required: true
    push:
        branches: [master]
        paths:
            - ".github/workflows/scorecard.yml"
            - "api/*.py"
    pull_request:
        branches: [master]

permissions:
    contents: read

jobs:
    analysis:
        name: Scorecard analysis
        runs-on: ubuntu-latest
        if: |
            github.actor != 'dependabot[bot]' &&
            github.actor != 'github-actions[bot]' &&
            github.actor != 'protected-auto-commits[bot]'
        permissions:
            security-events: write
            id-token: write
        steps:
          - name: Harden the runner
            uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
            with:
                egress-policy: audit

          - name: Checkout code
            uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
            with:
                persist-credentials: false

          - name: Run analysis
            uses: ossf/scorecard-action@05b42c624433fc40578a4040d5cf5e36ddca8cde # v2.4.2
            with:
                results_file: results.sarif
                results_format: sarif
                publish_results: true

          - name: Upload artifact
            uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
            with:
                name: SARIF file
                path: results.sarif

          - name: Upload to code-scanning
            uses: github/codeql-action/upload-sarif@3c3833e0f8c1c83d449a7478aa59c036a9165498 # v3.29.11
            with:
                sarif_file: results.sarif
